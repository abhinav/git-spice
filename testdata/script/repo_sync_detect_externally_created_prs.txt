# 'repo sync' detects and deletes branches for PRs
# that were created externally and then merged.
# Does not delete branches with an open PR.

as 'Test <test@example.com>'
at '2024-06-05T05:29:28Z'

# setup
cd repo
git init
git commit --allow-empty -m 'Initial commit'

# set up a fake GitHub remote
shamhub init
shamhub new origin alice/example.git
shamhub register alice
git push origin main

env SHAMHUB_USERNAME=alice
gs auth login

# Create a new branch and submit it
git add feature1.txt
gs bc -m 'Add feature1' feature1
gs branch submit --fill
stderr 'Created #'

# Create another branch, submit it,
# and create a local unpushed change.
gs trunk
git add feature2.txt
gs bc -m 'Add feature2' feature2
gs branch submit --fill
mv $WORK/extra/modified-feature2.txt feature2.txt
git add feature2.txt
gs cc -m 'Modify feature2'

# Create a third branch, submit and merge it.
gs trunk
git add feature3-v1.txt
gs bc -m 'Add feature3 v1' feature3
gs branch submit --fill
stderr 'Created #'
shamhub merge alice/example 3

# Sync to delete feature3
gs repo sync
stderr 'feature3: #3 was merged'
! git rev-parse --verify feature3

# Delete the remote branch so we can reuse the same branch name for the next PR
git push origin --delete feature3

# Create a new branch with the same name feature3 and submit it.
gs trunk
git add feature3-v2.txt
gs bc -m 'Add feature3 v2' feature3
gs branch submit --fill
stderr 'Created #'

# Forget all state.
gs repo init --reset --trunk=main --remote=origin
# At this point, gs has no knowledge of the PRs.

# Merge feature1 and feature2 server-side. Do not merge feature3 so PR #4 is still open.
shamhub merge alice/example 1
shamhub merge alice/example 2

# Track the branches and sync.
gs branch track --base=main feature1
gs branch track --base=main feature2
gs branch track --base=main feature3
gs repo sync
stderr 'feature1: #1 was merged'
stderr 'feature2: #2 was merged but local SHA \(6b83ef3\) does not match remote SHA \(33f1653\). Skipping'
# feature3 should not be reported as merged because PR #4 is still open
! stderr 'feature3.*was merged'

git graph --branches
cmp stdout $WORK/golden/merged-log.txt

shamhub dump changes
cmpenvJSON stdout $WORK/golden/pull.json

-- repo/feature1.txt --
Contents of feature

-- repo/feature2.txt --
Contents of feature2

-- repo/feature3-v1.txt --
Contents of feature3 v1

-- repo/feature3-v2.txt --
Contents of feature3 v2

-- extra/modified-feature2.txt --
New contents of feature2

-- golden/merged-log.txt --
* 6b83ef3 (feature2) Modify feature2
| * 24a756d (HEAD -> feature3, origin/feature3) Add feature3 v2
| | *   478956e (origin/main, main) Merge change #2
| | |\  
| |_|/  
|/| |   
* | | 33f1653 (origin/feature2) Add feature2
| | * e6e05a1 Merge change #1
| |/| 
| | * 7bf98f4 Add feature1
| |/  
|/|   
| * 5bf1af3 Merge change #3
|/| 
| * 5eadeb7 Add feature3 v1
|/  
* 13538da Initial commit
-- golden/pull.json --
[
  {
    "number": 1,
    "state": "closed",
    "title": "Add feature1",
    "body": "",
    "merged": true,
    "html_url": "$SHAMHUB_URL/alice/example/change/1",
    "head": {
      "repository": {
        "owner": "alice",
        "name": "example"
      },
      "ref": "feature1",
      "sha": "7bf98f4bf69e9ba74fdcfc42ac5b8b30dcccaf13"
    },
    "base": {
      "repository": {
        "owner": "alice",
        "name": "example"
      },
      "ref": "main",
      "sha": "478956e24c966031e82588f5962f112d2076ef10"
    }
  },
  {
    "base": {
      "repository": {
        "owner": "alice",
        "name": "example"
      },
      "ref": "main",
      "sha": "478956e24c966031e82588f5962f112d2076ef10"
    },
    "body": "",
    "head": {
      "repository": {
        "owner": "alice",
        "name": "example"
      },
      "ref": "feature2",
      "sha": "33f16530f499eb13bbe639deeed206df958c5b5a"
    },
    "html_url": "$SHAMHUB_URL/alice/example/change/2",
    "merged": true,
    "number": 2,
    "state": "closed",
    "title": "Add feature2"
  },
  {
    "number": 3,
    "state": "closed",
    "title": "Add feature3 v1",
    "body": "",
    "merged": true,
    "html_url": "$SHAMHUB_URL/alice/example/change/3",
    "head": {
      "repository": {
        "owner": "alice",
        "name": "example"
      },
      "ref": "feature3",
      "sha": "24a756d6cd38b02016397e63a4d55715e90c7101"
    },
    "base": {
      "repository": {
        "owner": "alice",
        "name": "example"
      },
      "ref": "main",
      "sha": "478956e24c966031e82588f5962f112d2076ef10"
    }
  },
  {
    "number": 4,
    "state": "open",
    "title": "Add feature3 v2",
    "body": "",
    "html_url": "$SHAMHUB_URL/alice/example/change/4",
    "head": {
      "repository": {
        "owner": "alice",
        "name": "example"
      },
      "ref": "feature3",
      "sha": "24a756d6cd38b02016397e63a4d55715e90c7101"
    },
    "base": {
      "repository": {
        "owner": "alice",
        "name": "example"
      },
      "ref": "main",
      "sha": "478956e24c966031e82588f5962f112d2076ef10"
    }
  }
]
