# submit a stack of PRs with 'stack submit' and reviewers.
# Tests reviewer deduplication and already-requested reviewers.

as 'Test <test@example.com>'
at '2024-04-05T16:40:32Z'

# setup
cd repo
git init
git commit --allow-empty -m 'Initial commit'

# set up a fake GitHub remote
shamhub init
shamhub new origin alice/example.git
shamhub register alice
shamhub register bob
shamhub register charlie
shamhub register dave
git push origin main

# create a stack:
# main -> feature1 -> feature2 -> feature3
git add feature1.txt
gs branch create feature1 -m 'Add feature 1'
git add feature2.txt
gs branch create feature2 -m 'Add feature 2'
git add feature3.txt
gs branch create feature3 -m 'Add feature 3'

env SHAMHUB_USERNAME=alice
gs auth login

git config spice.submit.reviewers bob

# submit the entire stack from the middle.
gs bco feature2
gs stack submit --fill --reviewer charlie
shamhub dump changes
cmpenvJSON stdout $WORK/golden/start.json

# Merge the bottom PR, sync, restack,
# and submit with new reviewer.
shamhub merge alice/example 1
gs rs
stderr '#1 was merged'
gs sr   # stack restack
gs ss --fill --reviewer dave
! stderr 'Updated #1'
stderr 'Updated #2'
stderr 'Updated #3'

shamhub dump changes
cmpenvJSON stdout $WORK/golden/updated.json

-- repo/feature1.txt --
This is feature 1
-- repo/feature2.txt --
This is feature 2
-- repo/feature3.txt --
This is feature 3

-- golden/start.json --
[
  {
    "number": 1,
    "state": "open",
    "title": "Add feature 1",
    "body": "",
    "html_url": "$SHAMHUB_URL/alice/example/change/1",
    "head": {
      "repository": {
        "owner": "alice",
        "name": "example"
      },
      "ref": "feature1",
      "sha": "8526d1a7195abb635f28bc93155b9155b76f3881"
    },
    "base": {
      "repository": {
        "owner": "alice",
        "name": "example"
      },
      "ref": "main",
      "sha": "ece8ed7bb81d74cb6787309fa41b7deb2e0558a3"
    },
    "requested_reviewers": ["bob", "charlie"]
  },
  {
    "number": 2,
    "state": "open",
    "title": "Add feature 2",
    "body": "",
    "html_url": "$SHAMHUB_URL/alice/example/change/2",
    "head": {
      "repository": {
        "owner": "alice",
        "name": "example"
      },
      "ref": "feature2",
      "sha": "9806160f3b27dbff81e496260d26fc32f5ee5cf0"
    },
    "base": {
      "repository": {
        "owner": "alice",
        "name": "example"
      },
      "ref": "feature1",
      "sha": "8526d1a7195abb635f28bc93155b9155b76f3881"
    },
    "requested_reviewers": ["bob", "charlie"]
  },
  {
    "number": 3,
    "state": "open",
    "title": "Add feature 3",
    "body": "",
    "html_url": "$SHAMHUB_URL/alice/example/change/3",
    "head": {
      "repository": {
        "owner": "alice",
        "name": "example"
      },
      "ref": "feature3",
      "sha": "63b2d337c8172c9f79aec9c760efc95e3c0c8472"
    },
    "base": {
      "repository": {
        "owner": "alice",
        "name": "example"
      },
      "ref": "feature2",
      "sha": "9806160f3b27dbff81e496260d26fc32f5ee5cf0"
    },
    "requested_reviewers": ["bob", "charlie"]
  }
]

-- golden/updated.json --
[
  {
    "number": 1,
    "state": "closed",
    "merged": true,
    "title": "Add feature 1",
    "body": "",
    "html_url": "$SHAMHUB_URL/alice/example/change/1",
    "head": {
      "repository": {
        "owner": "alice",
        "name": "example"
      },
      "ref": "feature1",
      "sha": "8526d1a7195abb635f28bc93155b9155b76f3881"
    },
    "base": {
      "repository": {
        "owner": "alice",
        "name": "example"
      },
      "ref": "main",
      "sha": "59d3064874a8d0a003755556a982d1fe8adb59dc"
    },
    "requested_reviewers": ["bob", "charlie"]
  },
  {
    "number": 2,
    "state": "open",
    "title": "Add feature 2",
    "body": "",
    "html_url": "$SHAMHUB_URL/alice/example/change/2",
    "head": {
      "repository": {
        "owner": "alice",
        "name": "example"
      },
      "ref": "feature2",
      "sha": "18e5a5208175cd409480c2ab89588877726c1d57"
    },
    "base": {
      "repository": {
        "owner": "alice",
        "name": "example"
      },
      "ref": "main",
      "sha": "59d3064874a8d0a003755556a982d1fe8adb59dc"
    },
    "requested_reviewers": ["bob", "charlie", "dave"]
  },
  {
    "number": 3,
    "state": "open",
    "title": "Add feature 3",
    "body": "",
    "html_url": "$SHAMHUB_URL/alice/example/change/3",
    "head": {
      "repository": {
        "owner": "alice",
        "name": "example"
      },
      "ref": "feature3",
      "sha": "aa7889fb8c0037d05573a0d27cacfcc78c5f1ba4"
    },
    "base": {
      "repository": {
        "owner": "alice",
        "name": "example"
      },
      "ref": "feature2",
      "sha": "18e5a5208175cd409480c2ab89588877726c1d57"
    },
    "requested_reviewers": ["bob", "charlie", "dave"]
  }
]
