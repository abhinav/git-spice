# Test that branch split allows reusing the original branch name
# for intermediate commits in non-interactive mode using --at flags.
#
# This tests the non-interactive version of the functionality
# requested in issue #411.

as 'Test <test@example.com>'
at '2024-06-23T10:00:12Z'

cd repo
git init
git commit --allow-empty -m 'Initial commit'
gs repo init

git add feature1.txt
gs bc -m 'Add feature1' features
git add feature2.txt
gs cc -m 'Add feature2'
git add feature3.txt
gs cc -m 'Add feature3'

gs ll -a
cmp stderr $WORK/golden/before.txt

# Split using --at flags, reusing original branch name for first commit
# and providing names for second and third commits
gs branch split --at a3a4c59:features --at 0c7ed55:feature2 --at 1b17c72:feature3

gs ll -a
cmp stderr $WORK/golden/after.txt

# Should be on feature3 branch with clean working tree
git branch --show-current
cmp stdout $WORK/golden/current_branch.txt

git status --porcelain
! stdout .

-- repo/feature1.txt --
feature1
-- repo/feature2.txt --
feature2
-- repo/feature3.txt --
feature3
-- golden/before.txt --
┏━■ features ◀
┃   1b17c72 Add feature3 (now)
┃   0c7ed55 Add feature2 (now)
┃   a3a4c59 Add feature1 (now)
main
-- golden/after.txt --
    ┏━■ feature3 ◀
    ┃   1b17c72 Add feature3 (now)
  ┏━┻□ feature2
  ┃    0c7ed55 Add feature2 (now)
┏━┻□ features
┃    a3a4c59 Add feature1 (now)
main
-- golden/current_branch.txt --
feature3
