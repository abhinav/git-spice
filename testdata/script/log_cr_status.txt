# 'gs log' supports a status indicator controlled by --cr-status/configuration.

as 'Test <test@example.com>'
at '2025-09-23T19:12:00Z'

mkdir repo
cd repo
git init
git commit --allow-empty -m 'Initial commit'
gs repo init

# set up a fake remote
shamhub init
shamhub register alice
shamhub new origin alice/example.git
git push origin main
env SHAMHUB_USERNAME=alice
gs auth login

# create stack feat1 -> feat2 -> feat3 -> feat4
git add feat1.txt
gs bc feat1 -m 'feat1'
git add feat2.txt
gs bc feat2 -m 'feat2'
git add feat3.txt
gs bc feat3 -m 'feat3'

# submit feat1-3, leave feat4 unsubmitted
gs bco feat3
gs dss --fill

# server-side, merge feat1, close feat3.
shamhub merge alice/example 1
shamhub reject alice/example 3

# Test: no cr-status
gs ls
cmp stderr $WORK/golden/ls-without-status.txt
gs ll
cmp stderr $WORK/golden/ll-without-status.txt

# Test: with CLI flag
gs ls -S
cmp stderr $WORK/golden/ls-with-status.txt
gs ll -S
cmp stderr $WORK/golden/ll-with-status.txt

# Test: with config
git config spice.log.crStatus true
gs ls
cmp stderr $WORK/golden/ls-with-status.txt
gs ll
cmp stderr $WORK/golden/ll-with-status.txt

# Test: JSON
gs ls --json --no-cr-status
cmpenv stdout $WORK/golden/ls-without-status.json
gs ll --json --no-cr-status
cmpenv stdout $WORK/golden/ll-without-status.json
gs ls --json
cmpenv stdout $WORK/golden/ls-with-status.json
gs ll --json
cmpenv stdout $WORK/golden/ll-with-status.json

-- repo/feat1.txt --
feat1
-- repo/feat2.txt --
feat2
-- repo/feat3.txt --
feat3
-- repo/feat4.txt --
feat4

-- golden/ls-without-status.txt --
    ┏━■ feat3 (#3) ◀
  ┏━┻□ feat2 (#2)
┏━┻□ feat1 (#1)
main
-- golden/ll-without-status.txt --
    ┏━■ feat3 (#3) ◀
    ┃   67480b6 feat3 (now)
  ┏━┻□ feat2 (#2)
  ┃    769cbf5 feat2 (now)
┏━┻□ feat1 (#1)
┃    ed5e364 feat1 (now)
main
-- golden/ls-with-status.txt --
    ┏━■ feat3 (#3 closed) ◀
  ┏━┻□ feat2 (#2 open)
┏━┻□ feat1 (#1 merged)
main
-- golden/ll-with-status.txt --
    ┏━■ feat3 (#3 closed) ◀
    ┃   67480b6 feat3 (now)
  ┏━┻□ feat2 (#2 open)
  ┃    769cbf5 feat2 (now)
┏━┻□ feat1 (#1 merged)
┃    ed5e364 feat1 (now)
main
-- golden/ls-without-status.json --
{"name":"feat1","down":{"name":"main"},"ups":[{"name":"feat2"}],"change":{"id":"#1","url":"$SHAMHUB_URL/alice/example/changes/1"},"push":{"ahead":0,"behind":0}}
{"name":"feat2","down":{"name":"feat1"},"ups":[{"name":"feat3"}],"change":{"id":"#2","url":"$SHAMHUB_URL/alice/example/changes/2"},"push":{"ahead":0,"behind":0}}
{"name":"feat3","current":true,"down":{"name":"feat2"},"change":{"id":"#3","url":"$SHAMHUB_URL/alice/example/changes/3"},"push":{"ahead":0,"behind":0}}
{"name":"main","ups":[{"name":"feat1"}]}
-- golden/ll-without-status.json --
{"name":"feat1","down":{"name":"main"},"ups":[{"name":"feat2"}],"commits":[{"sha":"ed5e364e35378f4b742951de90ec15d10fd6aae2","subject":"feat1"}],"change":{"id":"#1","url":"$SHAMHUB_URL/alice/example/changes/1"},"push":{"ahead":0,"behind":0}}
{"name":"feat2","down":{"name":"feat1"},"ups":[{"name":"feat3"}],"commits":[{"sha":"769cbf5b61f500126a5580d6fd8e89ac78c468da","subject":"feat2"}],"change":{"id":"#2","url":"$SHAMHUB_URL/alice/example/changes/2"},"push":{"ahead":0,"behind":0}}
{"name":"feat3","current":true,"down":{"name":"feat2"},"commits":[{"sha":"67480b64efd70742a4cf6da3cf01c56bddc14fe8","subject":"feat3"}],"change":{"id":"#3","url":"$SHAMHUB_URL/alice/example/changes/3"},"push":{"ahead":0,"behind":0}}
{"name":"main","ups":[{"name":"feat1"}]}
-- golden/ls-with-status.json --
{"name":"feat1","down":{"name":"main"},"ups":[{"name":"feat2"}],"change":{"id":"#1","url":"$SHAMHUB_URL/alice/example/changes/1","status":"merged"},"push":{"ahead":0,"behind":0}}
{"name":"feat2","down":{"name":"feat1"},"ups":[{"name":"feat3"}],"change":{"id":"#2","url":"$SHAMHUB_URL/alice/example/changes/2","status":"open"},"push":{"ahead":0,"behind":0}}
{"name":"feat3","current":true,"down":{"name":"feat2"},"change":{"id":"#3","url":"$SHAMHUB_URL/alice/example/changes/3","status":"closed"},"push":{"ahead":0,"behind":0}}
{"name":"main","ups":[{"name":"feat1"}]}
-- golden/ll-with-status.json --
{"name":"feat1","down":{"name":"main"},"ups":[{"name":"feat2"}],"commits":[{"sha":"ed5e364e35378f4b742951de90ec15d10fd6aae2","subject":"feat1"}],"change":{"id":"#1","url":"$SHAMHUB_URL/alice/example/changes/1","status":"merged"},"push":{"ahead":0,"behind":0}}
{"name":"feat2","down":{"name":"feat1"},"ups":[{"name":"feat3"}],"commits":[{"sha":"769cbf5b61f500126a5580d6fd8e89ac78c468da","subject":"feat2"}],"change":{"id":"#2","url":"$SHAMHUB_URL/alice/example/changes/2","status":"open"},"push":{"ahead":0,"behind":0}}
{"name":"feat3","current":true,"down":{"name":"feat2"},"commits":[{"sha":"67480b64efd70742a4cf6da3cf01c56bddc14fe8","subject":"feat3"}],"change":{"id":"#3","url":"$SHAMHUB_URL/alice/example/changes/3","status":"closed"},"push":{"ahead":0,"behind":0}}
{"name":"main","ups":[{"name":"feat1"}]}
